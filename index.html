<!doctype html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kurrency Konverter</title>
  <link rel="stylesheet" href="css/foundation.css?v=1" />
  <link rel="stylesheet" href="css/custom.css?v=1"/><!-- Custom stylesheet -->
  <link rel="icon" type="image/png" href="img/logo.png"><!-- favicon -->
  <script src="js/vendor/modernizr.js"></script>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script type="text/javascript">
  google.load('visualization', '1', {packages: ['annotatedtimeline']});
  </script>
</head>
<body>
  <div class="row">
    <div class="medium-2 large-2 columns">
      <div class="row">
        <div class="small-12 columns">
          <div class="logo-div color4"><!-- Div containing the logo -->
            <div class="centered"><img src="img/logo.png" alt="logo"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="medium-12 large-10 columns ">
      <div class="row ">
        <div class="small-12 columns">
          <div class="top-currencies-div color4"><!-- Div containing the top currencies -->
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">GBP</div>
                <div class="data-div">
                  <div class="percent-div">1.2%</div>
                  <div class="value-div">1.000</div>
                </div>
                <div class="arrow-div arrow-up"></div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">EUR</div>
                <div class="data-div">
                  <div class="percent-div">0.20%</div>
                  <div class="value-div">1.197</div>
                </div>
                <div class="arrow-div arrow-up"></div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">USD</div>
                <div class="data-div">
                  <div class="percent-div">0.30%</div>
                  <div class="value-div">1.668</div>
                </div>
                <div class="arrow-div arrow-up"></div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">INR</div>
                <div class="data-div">
                  <div class="percent-div">0.19%</div>
                  <div class="value-div">102.0</div>
                </div>
                <div class="arrow-div arrow-up"></div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">AUD</div>
                <div class="data-div">
                  <div class="percent-div">-0.33%</div>
                  <div class="value-div">1.842</div>
                </div>
                <div class="arrow-div arrow-down"></div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="symbol-div">CAD</div>
                <div class="data-div">
                  <div class="percent-div">-0.24%</div>
                  <div class="value-div">1.843</div>
                </div>
                <div class="arrow-div arrow-down"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row second-line">
    <div class="medium-6 large-3 columns">
      <div class="row ">
        <div class="small-12 columns">
          <div class="small-box converter-inputs color2"><!-- Div containing the inputs and the converter -->
            <div class="row">
              <div class="large-12 columns">
                <label>Home Currency</label>
                <input id="inputHomeCurrency" class="currencyselector" type="text" placeholder="EUR, GBP, USD..." />
              </div>
            </div>
            <div class="row">
              <div class="large-12 columns">
                <label>Host Currency</label>
                <input id="inputHostCurrency" class="currencyselector" type="text" placeholder="USD, EUR, GBP..." />
              </div>
            </div>
            <div class="row">
              <div class="large-12 columns converter">
                <div class="row collapse">
                  <label>Convert</label>
                  <div class="small-9 columns">
                    <input id="converterHomeCurrency" type="text" placeholder="100">
                  </div>
                  <div class="small-3 columns">
                    <span id="converterHomeCurrencyTip" class="postfix has-tip tip-right" data-tooltip title="Select your home currency to be able to convert from it.">K</span>
                  </div>
                </div>
                <div class="row collapse">
                  <label>to</label>
                  <div class="small-9 columns">
                    <input id="converterHostCurrency" type="text" placeholder="100">
                  </div>
                  <div class="small-3 columns">
                    <span id="converterHostCurrencyTip" class="postfix has-tip tip-right" data-tooltip title="Select your host currency to be able to convert to it.">K</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="medium-12 large-6 columns">
      <div class="row ">
        <div class="small-12 columns">
          <div class="small-box graph color3"><!-- Div containing the graph -->
            <div id="visualization" style="width: 100%; height: 350px;"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="medium-6 large-3 columns">
      <div class="row ">
        <div class="small-12 columns">
          <div class="small-box prediction color2"><!-- Div containing the next predicted low point -->
            <div class="centered">Next predicted low point:</div>
            <div class="centered">31/03/2014</div>
          </div>
        </div>
      </div>
    </div>
    <div class="medium-6 large-3 columns">
      <div class="row">
        <div class="small-12 columns">
          <div class="small-box threshold color2"><!-- Div containing the input to set a threshold, the input for the email and the button to connect with facebook -->
            <div class="row">
              <div class="large-12 columns">
                <div class="centered">Set threshold</div>
              </div>
            </div>
            <div class="row">
              <div class="large-12 columns">
                <label>Target Value</label>
                <input type="text" placeholder="1.25" />
              </div>
            </div>
            <div class="row collapse">
              <label>Email Alert</label>
              <div class="large-10 columns">
                <input type="text" placeholder="name@example.com" />
              </div>
              <div class="large-2 columns">
                <a href="#" class="button postfix">Go</a>
              </div>
            </div>
            <div class="row">
              <div class="large-12 columns">
                <label>Facebook Connect</label>
                <img src="img/facebooklogin.png"  alt="Facebook Login Button">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row third-line">
    <div class="small-6 medium-3 columns">
      <div class="row">
        <div class="small-12 columns">
          <div class="small-box map color2"><!-- Div containing the image to display the popup map -->
            <div class="centered">Currency use in the world</div>
            <a data-reveal-id="mapModal" href="#"><img src="img/worldmap_currencies_small.png"  alt="Worldmap of currencies"></a>
          </div>
        </div>
      </div>
    </div>
    <div class="small-12 medium-9 columns">
      <div class="row ">
        <div class="small-12 columns">
          <div class="price-beer color4"><!-- Div containing the price of beers in the world -->
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
            <div class="small-2 columns box">
              <div class="small-box color2">
                <div class="priceDiv">
                  <div class="price">£2.75</div>
                  <div class="images">
                    <img src="img/beer.png" class="beer" alt="beer">
                    <img src="img/ukflag.jpg" class="flag" alt="flag-uk">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div data-reveal class="reveal-modal" id="mapModal"><!-- Div containing the Google Map for the currencies use in the world -->
    <h3>Use of selected currencies worldwide</h3>
    <div id="worldmap">
      <div id="googft-mapCanvas" class="map"></div>
    </div>
    <a class="close-reveal-modal">×</a>
  </div>
  <div id="results">
  </div>
  <script src="js/vendor/jquery.js"></script>
  <script src="js/jquery-ui-1.10.4.custom.js"></script>
  <script src="js/foundation.min.js"></script>
  <script>
  availableCurrencies = [];
  window.homeCurrency = "";
  window.hostCurrency = "";
  function log(thing){
    console.log(thing);
  }
  $(document).foundation();

  $(function() {
    var query = "https://www.googleapis.com/fusiontables/v1/query?sql=SELECT+'ISO+code'+++FROM+1bTMHLs315h5NmkkucBAXYSeQjoiGXQyw0-4y_1nP+GROUP+BY+'ISO+code'+ORDER+BY+'ISO+code'+ASC&hdrs=false&typed=true&key=AIzaSyCCdCZEl31z9YPzDfX7kNOYY09ErJwCArM"
    $.ajax({
      url: query,
      cache: false
    })
    .done(function( json ) {
      for (var i = 0; i< json.rows.length; i++) {
        availableCurrencies.push(json.rows[i][0]);
      };
      $( ".currencyselector" ).autocomplete({
        source: availableCurrencies,
        autoFocus: true,
        delay: 500
      });
      $('.ui-autocomplete').addClass('f-dropdown');
      log(availableCurrencies);
    });
    getPopularCurrencies();
    inputHomeCurrency = document.getElementById("inputHomeCurrency");
    inputHomeCurrency.addEventListener("input", currencyHandler, true);
    inputHostCurrency = document.getElementById("inputHostCurrency");
    inputHostCurrency.addEventListener("input", currencyHandler, true);
    converterHomeCurrencyTip = document.getElementById("converterHomeCurrencyTip");
    converterHostCurrencyTip = document.getElementById("converterHostCurrencyTip");
    intervalCurrencies = setInterval(currencyHandler, 1000);
    function currencyHandler(){
      if(checkInput(inputHomeCurrency)){
        log(inputHomeCurrency);
        colorText(inputHomeCurrency,"green");
        converterHomeCurrencyTip.innerHTML = inputHomeCurrency.value;
        window.homeCurrency = inputHomeCurrency.value;
      }else{
        colorText(inputHomeCurrency,"red");
      }
      if(checkInput(inputHostCurrency)){
        log(inputHostCurrency);
        colorText(inputHostCurrency,"green");
        converterHostCurrencyTip.innerHTML = inputHostCurrency.value;
        window.hostCurrency = inputHostCurrency.value;
      }else{
        colorText(inputHostCurrency,"red");
      }
      if(checkInput(inputHomeCurrency) && checkInput(inputHostCurrency)){
        log("2 currencies selected, let's rock");
        getRates();
        getPopularCurrencies();
        drawVisualization();
        clearInterval(intervalCurrencies);
        intervalCurrencies = false;
      }else{
        if(!intervalCurrencies)
          intervalCurrencies = setInterval(currencyHandler, 1000);
      }
    }
    function getRates(){

      $.ajax({
        dataType: "jsonp",
        url: "http://lemichel.eu/rgu/kurrencykonverter/controller.php?action=getrates&home="+window.homeCurrency+"&host="+window.hostCurrency+"&callback=mycallback",
        success: function( response ) {
          saveRates( response );
        }
      });

      log("getRates() finished");
    }
    function saveRates( json ){
      log(json[0]);
      log(json[1]);
      if(json[0].currency_code==window.homeCurrency){
        window.homeRate = json[0].value;
        window.hostRate = json[1].value;
      }else{
        window.homeRate = json[1].value;
        window.hostRate = json[0].value;
      }
      setConverter();
      
      
    }
    function setConverter(){
      converterHomeCurrency = document.getElementById("converterHomeCurrency");
      converterHomeCurrency.addEventListener("input", converter, true);
      converterHostCurrency = document.getElementById("converterHostCurrency");
      converterHostCurrency.addEventListener("input", converter, true);
      converterHomeCurrency.placeholder = (1/window.homeRate*window.hostRate).toFixed(3);
      converterHostCurrency.placeholder = (1/window.hostRate*window.homeRate).toFixed(3);
    }
    function drawVisualization() {
      $.ajax({
        dataType: "jsonp",
        url: "http://lemichel.eu/rgu/kurrencykonverter/controller.php?action=getcurrencieshistory&home="+window.homeCurrency+"&host="+window.hostCurrency+"&callback=mycallback",
        success: function( response ) {
          log(response);
          myarr=[];
          $.each(response, function(key, val) {
            var data = [];
            value = parseFloat(val.value);
            date = parseDate(val.time);
            valueObj = {v: value, f: value.toFixed(2)};
            if(val.currency_code==window.homeCurrency){
              var data = [date, valueObj, null];
            }
            else{
              var data = [date, null, valueObj];
            }
            myarr.push(data);
          });
          log(myarr);


          var data = new google.visualization.DataTable();
          data.addColumn('datetime', 'Date');
          data.addColumn('number', 'Home Curr.');
          data.addColumn('number', 'Host Curr.');
          data.addRows(myarr);

          var annotatedtimeline = new google.visualization.AnnotatedTimeLine(
            document.getElementById('visualization'));
          annotatedtimeline.draw(data, {'displayExactValues': true, scaleColumns:[1,2], scaleType: 'allmaximized'});
        }
      });
}

function getPopularCurrencies(){
  $.ajax({
        dataType: "jsonp",
        url: "http://lemichel.eu/rgu/kurrencykonverter/controller.php?action=getpopularcurrencies"+(window.homeCurrency==""?"":"&home="+window.homeCurrency)+(window.hostCurrency==""?"":"&host="+window.hostCurrency)+"&callback=mycallback",
        success: function( response ) {
          log( response );
          var symboldiv = document.getElementsByClassName("symbol-div");
          var percentdiv = document.getElementsByClassName("percent-div");
          var valuediv = document.getElementsByClassName("value-div");
          var arrowdiv = document.getElementsByClassName("arrow-div");
          $.each( response, function( key, value ) {
            symboldiv[key].textContent = value[0].currency_code
            valuediv[key].textContent = (1/(value[0].value)).toFixed(3);
            log(value[0].percent);
            var percent = new Number(value[0].percent);
            var percentFormatted = percent.toFixed(3);
            percentdiv[key].textContent = percentFormatted+"%";
            if(percent>=0){
              arrowdiv[key].className="arrow-div arrow-up";
            }else{
              arrowdiv[key].className="arrow-div arrow-down";
            }
          });



        }
      });
}


function parseDate(date) {
  var m = /^(\d{4})-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d)/.exec(date);
  var tzOffset = new Date(+m[1], +m[2] - 1, +m[3], +m[4], +m[5], +m[6]).getTimezoneOffset();

  return new Date(+m[1], +m[2] - 1, +m[3], +m[4], +m[5] - tzOffset, +m[6]);
}

function converter(e){
  if(e.target==converterHomeCurrency){
    converterHostCurrency.value = (converterHomeCurrency.value/window.homeRate*window.hostRate).toFixed(3);
  }else{
    converterHomeCurrency.value = (converterHostCurrency.value/window.hostRate*window.homeRate).toFixed(3);
  }
}

function colorText(elem,color){
  elem.style.color=color;
}
function checkInput(input){
  return ( availableCurrencies.indexOf(input.value) == -1 ) ? false : true;
}

});

</script>
<script type="text/javascript">
function initialize() {
  google.maps.visualRefresh = true;
  var isMobile = (navigator.userAgent.toLowerCase().indexOf('android') > -1) ||
  (navigator.userAgent.match(/(iPod|iPhone|iPad|BlackBerry|Windows Phone|iemobile)/));
  if (isMobile) {
    var viewport = document.querySelector("meta[name=viewport]");
    viewport.setAttribute('content', 'initial-scale=1.0, user-scalable=no');
  }
  var mapDiv = document.getElementById('googft-mapCanvas');
  mapDiv.style.width = isMobile ? '100%' : '100%';
  mapDiv.style.height = isMobile ? '100%' : '90%';
  map = new google.maps.Map(mapDiv, {
    center: new google.maps.LatLng(0.0, 0.0),
    zoom: 2,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(document.getElementById('googft-legend-open'));
  map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(document.getElementById('googft-legend'));

  layer = new google.maps.FusionTablesLayer({
    map: map,
    heatmap: { enabled: false },
    query: {
      select: "col14",
      from: "1brA30s0zsBBH3u6NFn8Lk0i4V31W3fzvSEStct7g",
      where: "col3 in (\x27USD\x27, \x27EUR\x27)"
    },
    options: {
      styleId: 2,
      templateId: 2
    }
  });

  if (isMobile) {
    var legend = document.getElementById('googft-legend');
    var legendOpenButton = document.getElementById('googft-legend-open');
    var legendCloseButton = document.getElementById('googft-legend-close');
    legend.style.display = 'none';
    legendOpenButton.style.display = 'block';
    legendCloseButton.style.display = 'block';
    legendOpenButton.onclick = function() {
      legend.style.display = 'block';
      legendOpenButton.style.display = 'none';
    }
    legendCloseButton.onclick = function() {
      legend.style.display = 'none';
      legendOpenButton.style.display = 'block';
    }
  }
  $(document).on('open', '[data-reveal]', function () {


    /*layer.setOptions({
      query: {
        select: "col14",
        from: "1brA30s0zsBBH3u6NFn8Lk0i4V31W3fzvSEStct7g"
      }
    });*/


});
  $(document).on('opened', '[data-reveal]', function () {
    google.maps.event.trigger(window.map, 'resize');
    window.map = new google.maps.Map(mapDiv, {
      center: new google.maps.LatLng(20.0, 0.0),
      zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    /*layer.setOptions({
      query: {
        select: "col14",
        from: "1brA30s0zsBBH3u6NFn8Lk0i4V31W3fzvSEStct7g",
        where: "col3 in (\x27"+ window.homeCurrency +"\x27, \x27"+ window.hostCurrency +"\x27)"
      }
    });*/
  layer = new google.maps.FusionTablesLayer({
    map: window.map,
    heatmap: { enabled: false },
    query: {
      select: "col14",
      from: "1brA30s0zsBBH3u6NFn8Lk0i4V31W3fzvSEStct7g",
      where: "col3 in (\x27"+ window.homeCurrency +"\x27, \x27"+ window.hostCurrency +"\x27)"
    },
    options: {
      styleId: 2,
      templateId: 2
    }
  });
});
  window.map = map;
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>
</body>
</html>
